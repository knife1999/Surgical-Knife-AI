本插件二开 夏三七的大香蕉 (版本 1.7.0)

# 手术刀AI 使用文档（基于当前代码实现）

## 1. 项目定位

手术刀AI 是一个运行在 **Adobe Photoshop (UXP)** 内的插件，核心能力包括：

- 单图 AI 生成并回贴到当前选区
- 多任务批处理
- 文本/图像多模态 AI 对话
- 本地与云端提示词库管理
- 全局分区批量处理（针对所有已打开文档）

当前 `manifest` 仅配置了 Photoshop 主机（`PS`，`minVersion: 24.2.0`）。

## 2. 环境要求

- Photoshop 24.2.0 或更高版本
- Adobe UXP Developer Tool（用于开发调试加载）
- Node.js 18+

## 3. 开发与打包

项目主目录在 `xcyd_v2/`，常用命令如下：

```bash
# 安装依赖
npm i

# webview-ui 也需要单独安装依赖
cd webview-ui && npm i && cd ..

# 开发（watch 构建）
npm run dev

# 构建
npm run build

# 打包 CCX
npm run ccx

# 生成 ZIP（会附带 copyZipAssets 配置的资源）
npm run zip
```

## 4. 首次使用建议流程

1. 打开插件后先进入 `设置` 页面。
2. 在 `大香蕉Key管理` 新增你的图像生成 API Key。
3. 在 `AI对话 Key管理` 填入 AI 对话 Key，并点击 `获取模型列表`。
4. 回到 `单图处理`，确认 API 地址（默认 `https://ai.ajiai.top`）和提示词。
5. 在 Photoshop 中先创建选区，再点击 `开始生成(当前单图)`。

## 5. 页面功能说明

### 5.1 单图处理

功能：

- 基于当前文档选区抓取图像并请求 AI 生成
- 将结果自动回贴到原文档选区位置
- 支持一次生成多张（数量范围 1~5）
- 支持查询额度
- 支持将当前任务加入批处理队列
- 支持“保存当前提示词”到本地提示词库

关键参数：

- `API 地址`：默认 `https://ai.ajiai.top`
- `API Key`：来源于设置页保存的 Key 名称映射
- `分辨率档位`：`Auto / 1K / 2K / 4K`
- `数量`：单次请求张数（1~5）
- `超时(秒)`：请求超时阈值
- `图层类型`：`栅格化图层` 或 `智能对象`
- `传出压缩(长边)`：512~4096
- `抗截断模式`：`普通 / 高强`（再次点同按钮会关闭）

前置条件：

- 必须有活动文档
- 必须存在有效选区
- 提示词、API Key、API 地址不可为空

### 5.2 批处理

功能：

- 任务来自单图页 `+ 添加到批处理`
- 显示每个任务的文档名、参数摘要、提示词
- 支持删除单个任务/清空全部
- 一键执行全部任务并输出每组成功/失败统计

说明：

- 批处理执行时，相关文档不要关闭，否则会导致回贴失败。

### 5.3 与AI对话

功能：

- 从 `https://ai.comfly.chat/v1/models` 获取模型列表
- 调用 `https://ai.comfly.chat/v1/chat/completions` 进行对话
- 支持文本 + 多图输入
- 支持“上传当前图片”（从当前 Photoshop 选区抓图）
- 支持代码块渲染与一键复制
- 支持 JSON 模式（`转json`）并将返回 JSON 一键写入单图提示词（`使用`按钮）

可调参数：

- 上下文数量（1~30）
- max_tokens（1~32000）
- system prompt
- temperature / top_p / presence_penalty / frequency_penalty

### 5.4 提示词查询

功能：

- 按名称、标签检索
- 按来源筛选（本地/线上）
- 只看收藏
- 云端拉取提示词并合并到本地
- 详情查看、收藏切换、删除（仅本地）、修改（仅本地）
- 快捷 `使用` / `追加` 到单图提示词输入框

注意：

- 图书馆提示词（线上）只读，不可删除。
- `禁止自动拉取` 开启后，会跳过自动云端同步，仅使用本地缓存（可手动“从云端拉取提示词”）。

### 5.5 提示词新增

功能：

- 维护本地提示词条目（名称、内容、描述、分类、标签）
- 保存后会更新提示词总数与本地存储路径

### 5.6 图片预览（定制功能）

该页面默认隐藏，仅在“定制化功能开启”后显示。支持：

- 多图上传与轮播
- 鼠标滚轮缩放（以鼠标位置为中心）
- 拖拽平移
- 拖拽底部信息栏调整预览区域高度

### 5.7 设置

包含以下模块：

- 界面主题切换（自动持久化）
- 单图快捷键录制（默认 `Ctrl+Alt+Enter`）
- 功能码校验（通过后开启定制化功能）
- 大香蕉Key管理：新增/更新/删除/清空
- AI对话 Key管理：保存 Key、管理头像、获取/清空模型列表
- 图层与压缩快捷预设（1024/1536/2048/3072）
- 全局分区计算

全局分区规则：

- 横图：左上 + 右上
- 竖图：左上 + 左下
- 正方形：整图

执行范围为当前所有打开文档，耗时可能较长。

### 5.8 运行日志

页面底部统一记录各流程日志与错误信息，支持：

- 隐藏/显示日志
- 清空日志

建议排障时保留日志信息。

## 6. 快捷键与键盘交互

- 单图页支持自定义快捷键触发“开始生成”（默认 `Ctrl+Alt+Enter`）。
- 主页面支持方向键切换：
    - `←/→`：切换主 Tab
    - `↑/↓`：在输入控件间切换焦点

## 7. 数据存储与同步说明

### 7.1 本地 JSON 存储

插件会在 UXP 数据目录下维护：

- `prompt-create/prompt-create.json`

该文件包含：

- 提示词条目（本地与图书馆合并结果）
- 大香蕉 Key 列表
- AI 对话 Key
- 主题、启动确认、定制功能开关等状态

### 7.2 云端提示词源

- 拉取地址：`https://library.ai.pachouli.kiclover.com/public/list`
- 支持自动同步与手动强制同步

## 8. 常见问题

1. 提示“宿主接口未就绪/未挂载”
- 重新加载插件，确认当前运行在 Photoshop，并检查 UDT 加载状态。

2. 单图/批处理无法执行
- 检查是否已创建选区、API Key 是否有效、API 地址是否可访问。

3. 对话无模型
- 先在设置页保存 AI 对话 Key，再点击“获取模型列表”。

4. 提示词删除失败
- 仅本地提示词支持删除，线上图书馆提示词为只读。

5. 图片预览页看不到
- 该页是定制功能，需在设置页输入正确功能码后开启。

## 9. 相关默认接口

- 图像生成默认基地址：`https://ai.ajiai.top`
- 对话模型列表：`https://ai.comfly.chat/v1/models`
- 对话补全：`https://ai.comfly.chat/v1/chat/completions`
- 提示词图书馆：`https://library.ai.pachouli.kiclover.com/public/list`
